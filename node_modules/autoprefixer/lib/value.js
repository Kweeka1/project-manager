let Prefixer = require('./prefixer')
let OldValue = require('./old-value')
let vendor = require('./vendor')
let utils = require('./utils')

class Value extends Prefixer ***REMOVED***
  /**
   * Clone decl for each prefixed values
   */
  static save(prefixes, decl) ***REMOVED***
    let prop = decl.prop
    let result = []

    for (let prefix in decl._autoprefixerValues) ***REMOVED***
      let value = decl._autoprefixerValues[prefix]

      if (value === decl.value) ***REMOVED***
        continue
  ***REMOVED***

      let item
      let propPrefix = vendor.prefix(prop)

      if (propPrefix === '-pie-') ***REMOVED***
        continue
  ***REMOVED***

      if (propPrefix === prefix) ***REMOVED***
        item = decl.value = value
        result.push(item)
        continue
  ***REMOVED***

      let prefixed = prefixes.prefixed(prop, prefix)
      let rule = decl.parent

      if (!rule.every(i => i.prop !== prefixed)) ***REMOVED***
        result.push(item)
        continue
  ***REMOVED***

      let trimmed = value.replace(/\s+/, ' ')
      let already = rule.some(
        i => i.prop === decl.prop && i.value.replace(/\s+/, ' ') === trimmed
      )

      if (already) ***REMOVED***
        result.push(item)
        continue
  ***REMOVED***

      let cloned = this.clone(decl, ***REMOVED*** value ***REMOVED***)
      item = decl.parent.insertBefore(decl, cloned)

      result.push(item)
***REMOVED***

    return result
***REMOVED***

  /**
   * Is declaration need to be prefixed
   */
  check(decl) ***REMOVED***
    let value = decl.value
    if (!value.includes(this.name)) ***REMOVED***
      return false
***REMOVED***

    return !!value.match(this.regexp())
***REMOVED***

  /**
   * Lazy regexp loading
   */
  regexp() ***REMOVED***
    return this.regexpCache || (this.regexpCache = utils.regexp(this.name))
***REMOVED***

  /**
   * Add prefix to values in string
   */
  replace(string, prefix) ***REMOVED***
    return string.replace(this.regexp(), `$1$***REMOVED***prefix***REMOVED***$2`)
***REMOVED***

  /**
   * Get value with comments if it was not changed
   */
  value(decl) ***REMOVED***
    if (decl.raws.value && decl.raws.value.value === decl.value) ***REMOVED***
      return decl.raws.value.raw
***REMOVED*** else ***REMOVED***
      return decl.value
***REMOVED***
***REMOVED***

  /**
   * Save values with next prefixed token
   */
  add(decl, prefix) ***REMOVED***
    if (!decl._autoprefixerValues) ***REMOVED***
      decl._autoprefixerValues = ***REMOVED******REMOVED***
***REMOVED***
    let value = decl._autoprefixerValues[prefix] || this.value(decl)

    let before
    do ***REMOVED***
      before = value
      value = this.replace(value, prefix)
      if (value === false) return
***REMOVED*** while (value !== before)

    decl._autoprefixerValues[prefix] = value
***REMOVED***

  /**
   * Return function to fast find prefixed value
   */
  old(prefix) ***REMOVED***
    return new OldValue(this.name, prefix + this.name)
***REMOVED***
***REMOVED***

module.exports = Value

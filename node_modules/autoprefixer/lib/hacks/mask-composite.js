let Declaration = require('../declaration')

class MaskComposite extends Declaration ***REMOVED***
  /**
   * Prefix mask-composite for webkit
   */
  insert(decl, prefix, prefixes) ***REMOVED***
    let isCompositeProp = decl.prop === 'mask-composite'

    let compositeValues

    if (isCompositeProp) ***REMOVED***
      compositeValues = decl.value.split(',')
***REMOVED*** else ***REMOVED***
      compositeValues = decl.value.match(MaskComposite.regexp) || []
***REMOVED***

    compositeValues = compositeValues.map(el => el.trim()).filter(el => el)
    let hasCompositeValues = compositeValues.length

    let compositeDecl

    if (hasCompositeValues) ***REMOVED***
      compositeDecl = this.clone(decl)
      compositeDecl.value = compositeValues
        .map(value => MaskComposite.oldValues[value] || value)
        .join(', ')

      if (compositeValues.includes('intersect')) ***REMOVED***
        compositeDecl.value += ', xor'
  ***REMOVED***

      compositeDecl.prop = prefix + 'mask-composite'
***REMOVED***

    if (isCompositeProp) ***REMOVED***
      if (!hasCompositeValues) ***REMOVED***
        return undefined
  ***REMOVED***

      if (this.needCascade(decl)) ***REMOVED***
        compositeDecl.raws.before = this.calcBefore(prefixes, decl, prefix)
  ***REMOVED***

      return decl.parent.insertBefore(decl, compositeDecl)
***REMOVED***

    let cloned = this.clone(decl)
    cloned.prop = prefix + cloned.prop

    if (hasCompositeValues) ***REMOVED***
      cloned.value = cloned.value.replace(MaskComposite.regexp, '')
***REMOVED***

    if (this.needCascade(decl)) ***REMOVED***
      cloned.raws.before = this.calcBefore(prefixes, decl, prefix)
***REMOVED***

    decl.parent.insertBefore(decl, cloned)

    if (!hasCompositeValues) ***REMOVED***
      return decl
***REMOVED***

    if (this.needCascade(decl)) ***REMOVED***
      compositeDecl.raws.before = this.calcBefore(prefixes, decl, prefix)
***REMOVED***
    return decl.parent.insertBefore(decl, compositeDecl)
***REMOVED***
***REMOVED***

MaskComposite.names = ['mask', 'mask-composite']

MaskComposite.oldValues = ***REMOVED***
  add: 'source-over',
  subtract: 'source-out',
  intersect: 'source-in',
  exclude: 'xor'
***REMOVED***

MaskComposite.regexp = new RegExp(
  `\\s+($***REMOVED***Object.keys(MaskComposite.oldValues).join(
    '|'
  )***REMOVED***)\\b(?!\\))\\s*(?=[,])`,
  'ig'
)

module.exports = MaskComposite

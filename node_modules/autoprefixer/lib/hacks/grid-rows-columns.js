let Declaration = require('../declaration')
let ***REMOVED***
  prefixTrackProp,
  prefixTrackValue,
  autoplaceGridItems,
  getGridGap,
  inheritGridGap
***REMOVED*** = require('./grid-utils')
let Processor = require('../processor')

class GridRowsColumns extends Declaration ***REMOVED***
  /**
   * Change property name for IE
   */
  prefixed(prop, prefix) ***REMOVED***
    if (prefix === '-ms-') ***REMOVED***
      return prefixTrackProp(***REMOVED*** prop, prefix ***REMOVED***)
***REMOVED***
    return super.prefixed(prop, prefix)
***REMOVED***

  /**
   * Change IE property back
   */
  normalize(prop) ***REMOVED***
    return prop.replace(/^grid-(rows|columns)/, 'grid-template-$1')
***REMOVED***

  insert(decl, prefix, prefixes, result) ***REMOVED***
    if (prefix !== '-ms-') return super.insert(decl, prefix, prefixes)

    let ***REMOVED*** parent, prop, value ***REMOVED*** = decl
    let isRowProp = prop.includes('rows')
    let isColumnProp = prop.includes('columns')

    let hasGridTemplate = parent.some(
      i => i.prop === 'grid-template' || i.prop === 'grid-template-areas'
    )

    /**
     * Not to prefix rows declaration if grid-template(-areas) is present
     */
    if (hasGridTemplate && isRowProp) ***REMOVED***
      return false
***REMOVED***

    let processor = new Processor(***REMOVED*** options: ***REMOVED******REMOVED*** ***REMOVED***)
    let status = processor.gridStatus(parent, result)
    let gap = getGridGap(decl)
    gap = inheritGridGap(decl, gap) || gap

    let gapValue = isRowProp ? gap.row : gap.column

    if ((status === 'no-autoplace' || status === true) && !hasGridTemplate) ***REMOVED***
      gapValue = null
***REMOVED***

    let prefixValue = prefixTrackValue(***REMOVED***
      value,
      gap: gapValue
***REMOVED***)

    /**
     * Insert prefixes
     */
    decl.cloneBefore(***REMOVED***
      prop: prefixTrackProp(***REMOVED*** prop, prefix ***REMOVED***),
      value: prefixValue
***REMOVED***)

    let autoflow = parent.nodes.find(i => i.prop === 'grid-auto-flow')
    let autoflowValue = 'row'

    if (autoflow && !processor.disabled(autoflow, result)) ***REMOVED***
      autoflowValue = autoflow.value.trim()
***REMOVED***
    if (status === 'autoplace') ***REMOVED***
      /**
       * Show warning if grid-template-rows decl is not found
       */
      let rowDecl = parent.nodes.find(i => i.prop === 'grid-template-rows')

      if (!rowDecl && hasGridTemplate) ***REMOVED***
        return undefined
  ***REMOVED*** else if (!rowDecl && !hasGridTemplate) ***REMOVED***
        decl.warn(
          result,
          'Autoplacement does not work without grid-template-rows property'
        )
        return undefined
  ***REMOVED***

      /**
       * Show warning if grid-template-columns decl is not found
       */
      let columnDecl = parent.nodes.find(i => ***REMOVED***
        return i.prop === 'grid-template-columns'
  ***REMOVED***)
      if (!columnDecl && !hasGridTemplate) ***REMOVED***
        decl.warn(
          result,
          'Autoplacement does not work without grid-template-columns property'
        )
  ***REMOVED***

      /**
       * Autoplace grid items
       */
      if (isColumnProp && !hasGridTemplate) ***REMOVED***
        autoplaceGridItems(decl, result, gap, autoflowValue)
  ***REMOVED***
***REMOVED***

    return undefined
***REMOVED***
***REMOVED***

GridRowsColumns.names = [
  'grid-template-rows',
  'grid-template-columns',
  'grid-rows',
  'grid-columns'
]

module.exports = GridRowsColumns

let ***REMOVED*** list ***REMOVED*** = require('postcss')
let parser = require('postcss-value-parser')

let Browsers = require('./browsers')
let vendor = require('./vendor')

class Transition ***REMOVED***
  constructor(prefixes) ***REMOVED***
    this.props = ['transition', 'transition-property']
    this.prefixes = prefixes
***REMOVED***

  /**
   * Process transition and add prefixes for all necessary properties
   */
  add(decl, result) ***REMOVED***
    let prefix, prop
    let add = this.prefixes.add[decl.prop]
    let vendorPrefixes = this.ruleVendorPrefixes(decl)
    let declPrefixes = vendorPrefixes || (add && add.prefixes) || []

    let params = this.parse(decl.value)
    let names = params.map(i => this.findProp(i))
    let added = []

    if (names.some(i => i[0] === '-')) ***REMOVED***
      return
***REMOVED***

    for (let param of params) ***REMOVED***
      prop = this.findProp(param)
      if (prop[0] === '-') continue

      let prefixer = this.prefixes.add[prop]
      if (!prefixer || !prefixer.prefixes) continue

      for (prefix of prefixer.prefixes) ***REMOVED***
        if (vendorPrefixes && !vendorPrefixes.some(p => prefix.includes(p))) ***REMOVED***
          continue
    ***REMOVED***

        let prefixed = this.prefixes.prefixed(prop, prefix)
        if (prefixed !== '-ms-transform' && !names.includes(prefixed)) ***REMOVED***
          if (!this.disabled(prop, prefix)) ***REMOVED***
            added.push(this.clone(prop, prefixed, param))
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***
***REMOVED***

    params = params.concat(added)
    let value = this.stringify(params)

    let webkitClean = this.stringify(
      this.cleanFromUnprefixed(params, '-webkit-')
    )
    if (declPrefixes.includes('-webkit-')) ***REMOVED***
      this.cloneBefore(decl, `-webkit-$***REMOVED***decl.prop***REMOVED***`, webkitClean)
***REMOVED***
    this.cloneBefore(decl, decl.prop, webkitClean)
    if (declPrefixes.includes('-o-')) ***REMOVED***
      let operaClean = this.stringify(this.cleanFromUnprefixed(params, '-o-'))
      this.cloneBefore(decl, `-o-$***REMOVED***decl.prop***REMOVED***`, operaClean)
***REMOVED***

    for (prefix of declPrefixes) ***REMOVED***
      if (prefix !== '-webkit-' && prefix !== '-o-') ***REMOVED***
        let prefixValue = this.stringify(
          this.cleanOtherPrefixes(params, prefix)
        )
        this.cloneBefore(decl, prefix + decl.prop, prefixValue)
  ***REMOVED***
***REMOVED***

    if (value !== decl.value && !this.already(decl, decl.prop, value)) ***REMOVED***
      this.checkForWarning(result, decl)
      decl.cloneBefore()
      decl.value = value
***REMOVED***
***REMOVED***

  /**
   * Find property name
   */
  findProp(param) ***REMOVED***
    let prop = param[0].value
    if (/^\d/.test(prop)) ***REMOVED***
      for (let [i, token] of param.entries()) ***REMOVED***
        if (i !== 0 && token.type === 'word') ***REMOVED***
          return token.value
    ***REMOVED***
  ***REMOVED***
***REMOVED***
    return prop
***REMOVED***

  /**
   * Does we already have this declaration
   */
  already(decl, prop, value) ***REMOVED***
    return decl.parent.some(i => i.prop === prop && i.value === value)
***REMOVED***

  /**
   * Add declaration if it is not exist
   */
  cloneBefore(decl, prop, value) ***REMOVED***
    if (!this.already(decl, prop, value)) ***REMOVED***
      decl.cloneBefore(***REMOVED*** prop, value ***REMOVED***)
***REMOVED***
***REMOVED***

  /**
   * Show transition-property warning
   */
  checkForWarning(result, decl) ***REMOVED***
    if (decl.prop !== 'transition-property') ***REMOVED***
      return
***REMOVED***

    let isPrefixed = false
    let hasAssociatedProp = false

    decl.parent.each(i => ***REMOVED***
      if (i.type !== 'decl') ***REMOVED***
        return undefined
  ***REMOVED***
      if (i.prop.indexOf('transition-') !== 0) ***REMOVED***
        return undefined
  ***REMOVED***
      let values = list.comma(i.value)
      // check if current Rule's transition-property comma separated value list needs prefixes
      if (i.prop === 'transition-property') ***REMOVED***
        values.forEach(value => ***REMOVED***
          let lookup = this.prefixes.add[value]
          if (lookup && lookup.prefixes && lookup.prefixes.length > 0) ***REMOVED***
            isPrefixed = true
      ***REMOVED***
    ***REMOVED***)
        return undefined
  ***REMOVED***
      // check if another transition-* prop in current Rule has comma separated value list
      hasAssociatedProp = hasAssociatedProp || values.length > 1
      return false
***REMOVED***)

    if (isPrefixed && hasAssociatedProp) ***REMOVED***
      decl.warn(
        result,
        'Replace transition-property to transition, ' +
          'because Autoprefixer could not support ' +
          'any cases of transition-property ' +
          'and other transition-*'
      )
***REMOVED***
***REMOVED***

  /**
   * Process transition and remove all unnecessary properties
   */
  remove(decl) ***REMOVED***
    let params = this.parse(decl.value)
    params = params.filter(i => ***REMOVED***
      let prop = this.prefixes.remove[this.findProp(i)]
      return !prop || !prop.remove
***REMOVED***)
    let value = this.stringify(params)

    if (decl.value === value) ***REMOVED***
      return
***REMOVED***

    if (params.length === 0) ***REMOVED***
      decl.remove()
      return
***REMOVED***

    let double = decl.parent.some(i => ***REMOVED***
      return i.prop === decl.prop && i.value === value
***REMOVED***)
    let smaller = decl.parent.some(i => ***REMOVED***
      return i !== decl && i.prop === decl.prop && i.value.length > value.length
***REMOVED***)

    if (double || smaller) ***REMOVED***
      decl.remove()
      return
***REMOVED***

    decl.value = value
***REMOVED***

  /**
   * Parse properties list to array
   */
  parse(value) ***REMOVED***
    let ast = parser(value)
    let result = []
    let param = []
    for (let node of ast.nodes) ***REMOVED***
      param.push(node)
      if (node.type === 'div' && node.value === ',') ***REMOVED***
        result.push(param)
        param = []
  ***REMOVED***
***REMOVED***
    result.push(param)
    return result.filter(i => i.length > 0)
***REMOVED***

  /**
   * Return properties string from array
   */
  stringify(params) ***REMOVED***
    if (params.length === 0) ***REMOVED***
      return ''
***REMOVED***
    let nodes = []
    for (let param of params) ***REMOVED***
      if (param[param.length - 1].type !== 'div') ***REMOVED***
        param.push(this.div(params))
  ***REMOVED***
      nodes = nodes.concat(param)
***REMOVED***
    if (nodes[0].type === 'div') ***REMOVED***
      nodes = nodes.slice(1)
***REMOVED***
    if (nodes[nodes.length - 1].type === 'div') ***REMOVED***
      nodes = nodes.slice(0, +-2 + 1 || undefined)
***REMOVED***
    return parser.stringify(***REMOVED*** nodes ***REMOVED***)
***REMOVED***

  /**
   * Return new param array with different name
   */
  clone(origin, name, param) ***REMOVED***
    let result = []
    let changed = false
    for (let i of param) ***REMOVED***
      if (!changed && i.type === 'word' && i.value === origin) ***REMOVED***
        result.push(***REMOVED*** type: 'word', value: name ***REMOVED***)
        changed = true
  ***REMOVED*** else ***REMOVED***
        result.push(i)
  ***REMOVED***
***REMOVED***
    return result
***REMOVED***

  /**
   * Find or create separator
   */
  div(params) ***REMOVED***
    for (let param of params) ***REMOVED***
      for (let node of param) ***REMOVED***
        if (node.type === 'div' && node.value === ',') ***REMOVED***
          return node
    ***REMOVED***
  ***REMOVED***
***REMOVED***
    return ***REMOVED*** type: 'div', value: ',', after: ' ' ***REMOVED***
***REMOVED***

  cleanOtherPrefixes(params, prefix) ***REMOVED***
    return params.filter(param => ***REMOVED***
      let current = vendor.prefix(this.findProp(param))
      return current === '' || current === prefix
***REMOVED***)
***REMOVED***

  /**
   * Remove all non-webkit prefixes and unprefixed params if we have prefixed
   */
  cleanFromUnprefixed(params, prefix) ***REMOVED***
    let remove = params
      .map(i => this.findProp(i))
      .filter(i => i.slice(0, prefix.length) === prefix)
      .map(i => this.prefixes.unprefixed(i))

    let result = []
    for (let param of params) ***REMOVED***
      let prop = this.findProp(param)
      let p = vendor.prefix(prop)
      if (!remove.includes(prop) && (p === prefix || p === '')) ***REMOVED***
        result.push(param)
  ***REMOVED***
***REMOVED***
    return result
***REMOVED***

  /**
   * Check property for disabled by option
   */
  disabled(prop, prefix) ***REMOVED***
    let other = ['order', 'justify-content', 'align-self', 'align-content']
    if (prop.includes('flex') || other.includes(prop)) ***REMOVED***
      if (this.prefixes.options.flexbox === false) ***REMOVED***
        return true
  ***REMOVED***

      if (this.prefixes.options.flexbox === 'no-2009') ***REMOVED***
        return prefix.includes('2009')
  ***REMOVED***
***REMOVED***
    return undefined
***REMOVED***

  /**
   * Check if transition prop is inside vendor specific rule
   */
  ruleVendorPrefixes(decl) ***REMOVED***
    let ***REMOVED*** parent ***REMOVED*** = decl

    if (parent.type !== 'rule') ***REMOVED***
      return false
***REMOVED*** else if (!parent.selector.includes(':-')) ***REMOVED***
      return false
***REMOVED***

    let selectors = Browsers.prefixes().filter(s =>
      parent.selector.includes(':' + s)
    )

    return selectors.length > 0 ? selectors : false
***REMOVED***
***REMOVED***

module.exports = Transition

import process from 'node:process';
import fs from 'node:fs';
import path from 'node:path';
import fastGlob from 'fast-glob';
import gitIgnore from 'ignore';
import slash from 'slash';
import toPath from './to-path.js';

const DEFAULT_IGNORE = [
	'**/node_modules/**',
	'**/flow-typed/**',
	'**/coverage/**',
	'**/.git',
];

const mapGitIgnorePatternTo = base => ignore => ***REMOVED***
	if (ignore.startsWith('!')) ***REMOVED***
		return '!' + path.posix.join(base, ignore.slice(1));
	***REMOVED***

	return path.posix.join(base, ignore);
***REMOVED***;

const parseGitIgnore = (content, options) => ***REMOVED***
	const base = slash(path.relative(options.cwd, path.dirname(options.fileName)));

	return content
		.split(/\r?\n/)
		.filter(Boolean)
		.filter(line => !line.startsWith('#'))
		.map(mapGitIgnorePatternTo(base));
***REMOVED***;

const reduceIgnore = files => ***REMOVED***
	const ignores = gitIgnore();
	for (const file of files) ***REMOVED***
		ignores.add(parseGitIgnore(file.content, ***REMOVED***
			cwd: file.cwd,
			fileName: file.filePath,
		***REMOVED***));
	***REMOVED***

	return ignores;
***REMOVED***;

const ensureAbsolutePathForCwd = (cwd, p) => ***REMOVED***
	cwd = slash(cwd);
	if (path.isAbsolute(p)) ***REMOVED***
		if (slash(p).startsWith(cwd)) ***REMOVED***
			return p;
		***REMOVED***

		throw new Error(`Path $***REMOVED***p***REMOVED*** is not in cwd $***REMOVED***cwd***REMOVED***`);
	***REMOVED***

	return path.join(cwd, p);
***REMOVED***;

const getIsIgnoredPredicate = (ignores, cwd) => p => ignores.ignores(slash(path.relative(cwd, ensureAbsolutePathForCwd(cwd, toPath(p.path || p)))));

const getFile = async (file, cwd) => ***REMOVED***
	const filePath = path.join(cwd, file);
	const content = await fs.promises.readFile(filePath, 'utf8');

	return ***REMOVED***
		cwd,
		filePath,
		content,
	***REMOVED***;
***REMOVED***;

const getFileSync = (file, cwd) => ***REMOVED***
	const filePath = path.join(cwd, file);
	const content = fs.readFileSync(filePath, 'utf8');

	return ***REMOVED***
		cwd,
		filePath,
		content,
	***REMOVED***;
***REMOVED***;

const normalizeOptions = (***REMOVED***
	ignore = [],
	cwd = slash(process.cwd()),
***REMOVED*** = ***REMOVED******REMOVED***) => (***REMOVED***ignore: [...DEFAULT_IGNORE, ...ignore], cwd: toPath(cwd)***REMOVED***);

export const isGitIgnored = async options => ***REMOVED***
	options = normalizeOptions(options);

	const paths = await fastGlob('**/.gitignore', options);

	const files = await Promise.all(paths.map(file => getFile(file, options.cwd)));
	const ignores = reduceIgnore(files);

	return getIsIgnoredPredicate(ignores, options.cwd);
***REMOVED***;

export const isGitIgnoredSync = options => ***REMOVED***
	options = normalizeOptions(options);

	const paths = fastGlob.sync('**/.gitignore', options);

	const files = paths.map(file => getFileSync(file, options.cwd));
	const ignores = reduceIgnore(files);

	return getIsIgnoredPredicate(ignores, options.cwd);
***REMOVED***;

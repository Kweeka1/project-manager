import log, ***REMOVED*** dim ***REMOVED*** from './log'

export function normalizeConfig(config) ***REMOVED***
  // Quick structure validation
  /**
   * type FilePath = string
   * type RawFile = ***REMOVED*** raw: string, extension?: string ***REMOVED***
   * type ExtractorFn = (content: string) => Array<string>
   * type TransformerFn = (content: string) => string
   *
   * type Content =
   *   | Array<FilePath | RawFile>
   *   | ***REMOVED***
   *       files: Array<FilePath | RawFile>,
   *       extract?: ExtractorFn | ***REMOVED*** [extension: string]: ExtractorFn ***REMOVED***
   *       transform?: TransformerFn | ***REMOVED*** [extension: string]: TransformerFn ***REMOVED***
   * ***REMOVED***
   */
  let valid = (() => ***REMOVED***
    // `config.purge` should not exist anymore
    if (config.purge) ***REMOVED***
      return false
***REMOVED***

    // `config.content` should exist
    if (!config.content) ***REMOVED***
      return false
***REMOVED***

    // `config.content` should be an object or an array
    if (
      !Array.isArray(config.content) &&
      !(typeof config.content === 'object' && config.content !== null)
    ) ***REMOVED***
      return false
***REMOVED***

    // When `config.content` is an array, it should consist of FilePaths or RawFiles
    if (Array.isArray(config.content)) ***REMOVED***
      return config.content.every((path) => ***REMOVED***
        // `path` can be a string
        if (typeof path === 'string') return true

        // `path` can be an object ***REMOVED*** raw: string, extension?: string ***REMOVED***
        // `raw` must be a string
        if (typeof path?.raw !== 'string') return false

        // `extension` (if provided) should also be a string
        if (path?.extension && typeof path?.extension !== 'string') ***REMOVED***
          return false
    ***REMOVED***

        return true
  ***REMOVED***)
***REMOVED***

    // When `config.content` is an object
    if (typeof config.content === 'object' && config.content !== null) ***REMOVED***
      // Only `files`, `extract` and `transform` can exist in `config.content`
      if (
        Object.keys(config.content).some((key) => !['files', 'extract', 'transform'].includes(key))
      ) ***REMOVED***
        return false
  ***REMOVED***

      // `config.content.files` should exist of FilePaths or RawFiles
      if (Array.isArray(config.content.files)) ***REMOVED***
        if (
          !config.content.files.every((path) => ***REMOVED***
            // `path` can be a string
            if (typeof path === 'string') return true

            // `path` can be an object ***REMOVED*** raw: string, extension?: string ***REMOVED***
            // `raw` must be a string
            if (typeof path?.raw !== 'string') return false

            // `extension` (if provided) should also be a string
            if (path?.extension && typeof path?.extension !== 'string') ***REMOVED***
              return false
        ***REMOVED***

            return true
      ***REMOVED***)
        ) ***REMOVED***
          return false
    ***REMOVED***

        // `config.content.extract` is optional, and can be a Function or a Record<String, Function>
        if (typeof config.content.extract === 'object') ***REMOVED***
          for (let value of Object.values(config.content.extract)) ***REMOVED***
            if (typeof value !== 'function') ***REMOVED***
              return false
        ***REMOVED***
      ***REMOVED***
    ***REMOVED*** else if (
          !(config.content.extract === undefined || typeof config.content.extract === 'function')
        ) ***REMOVED***
          return false
    ***REMOVED***

        // `config.content.transform` is optional, and can be a Function or a Record<String, Function>
        if (typeof config.content.transform === 'object') ***REMOVED***
          for (let value of Object.values(config.content.transform)) ***REMOVED***
            if (typeof value !== 'function') ***REMOVED***
              return false
        ***REMOVED***
      ***REMOVED***
    ***REMOVED*** else if (
          !(
            config.content.transform === undefined || typeof config.content.transform === 'function'
          )
        ) ***REMOVED***
          return false
    ***REMOVED***
  ***REMOVED***

      return true
***REMOVED***

    return false
***REMOVED***)()

  if (!valid) ***REMOVED***
    log.warn('purge-deprecation', [
      'The `purge`/`content` options have changed in Tailwind CSS v3.0.',
      'Update your configuration file to eliminate this warning.',
      'https://tailwindcss.com/docs/upgrade-guide#configure-content-sources',
    ])
***REMOVED***

  // Normalize the `safelist`
  config.safelist = (() => ***REMOVED***
    let ***REMOVED*** content, purge, safelist ***REMOVED*** = config

    if (Array.isArray(safelist)) return safelist
    if (Array.isArray(content?.safelist)) return content.safelist
    if (Array.isArray(purge?.safelist)) return purge.safelist
    if (Array.isArray(purge?.options?.safelist)) return purge.options.safelist

    return []
***REMOVED***)()

  // Normalize prefix option
  if (typeof config.prefix === 'function') ***REMOVED***
    log.warn('prefix-function', [
      'As of Tailwind CSS v3.0, `prefix` cannot be a function.',
      'Update `prefix` in your configuration to be a string to eliminate this warning.',
      'https://tailwindcss.com/docs/upgrade-guide#prefix-cannot-be-a-function',
    ])
    config.prefix = ''
***REMOVED*** else ***REMOVED***
    config.prefix = config.prefix ?? ''
***REMOVED***

  // Normalize the `content`
  config.content = ***REMOVED***
    files: (() => ***REMOVED***
      let ***REMOVED*** content, purge ***REMOVED*** = config

      if (Array.isArray(purge)) return purge
      if (Array.isArray(purge?.content)) return purge.content
      if (Array.isArray(content)) return content
      if (Array.isArray(content?.content)) return content.content
      if (Array.isArray(content?.files)) return content.files

      return []
***REMOVED***)(),

    extract: (() => ***REMOVED***
      let extract = (() => ***REMOVED***
        if (config.purge?.extract) return config.purge.extract
        if (config.content?.extract) return config.content.extract

        if (config.purge?.extract?.DEFAULT) return config.purge.extract.DEFAULT
        if (config.content?.extract?.DEFAULT) return config.content.extract.DEFAULT

        if (config.purge?.options?.extractors) return config.purge.options.extractors
        if (config.content?.options?.extractors) return config.content.options.extractors

        return ***REMOVED******REMOVED***
  ***REMOVED***)()

      let extractors = ***REMOVED******REMOVED***

      let defaultExtractor = (() => ***REMOVED***
        if (config.purge?.options?.defaultExtractor) ***REMOVED***
          return config.purge.options.defaultExtractor
    ***REMOVED***

        if (config.content?.options?.defaultExtractor) ***REMOVED***
          return config.content.options.defaultExtractor
    ***REMOVED***

        return undefined
  ***REMOVED***)()

      if (defaultExtractor !== undefined) ***REMOVED***
        extractors.DEFAULT = defaultExtractor
  ***REMOVED***

      // Functions
      if (typeof extract === 'function') ***REMOVED***
        extractors.DEFAULT = extract
  ***REMOVED***

      // Arrays
      else if (Array.isArray(extract)) ***REMOVED***
        for (let ***REMOVED*** extensions, extractor ***REMOVED*** of extract ?? []) ***REMOVED***
          for (let extension of extensions) ***REMOVED***
            extractors[extension] = extractor
      ***REMOVED***
    ***REMOVED***
  ***REMOVED***

      // Objects
      else if (typeof extract === 'object' && extract !== null) ***REMOVED***
        Object.assign(extractors, extract)
  ***REMOVED***

      return extractors
***REMOVED***)(),

    transform: (() => ***REMOVED***
      let transform = (() => ***REMOVED***
        if (config.purge?.transform) return config.purge.transform
        if (config.content?.transform) return config.content.transform

        if (config.purge?.transform?.DEFAULT) return config.purge.transform.DEFAULT
        if (config.content?.transform?.DEFAULT) return config.content.transform.DEFAULT

        return ***REMOVED******REMOVED***
  ***REMOVED***)()

      let transformers = ***REMOVED******REMOVED***

      if (typeof transform === 'function') ***REMOVED***
        transformers.DEFAULT = transform
  ***REMOVED***

      if (typeof transform === 'object' && transform !== null) ***REMOVED***
        Object.assign(transformers, transform)
  ***REMOVED***

      return transformers
***REMOVED***)(),
***REMOVED***

  // Validate globs to prevent bogus globs.
  // E.g.: `./src/*.***REMOVED***html***REMOVED***` is invalid, the `***REMOVED***html***REMOVED***` should just be `html`
  for (let file of config.content.files) ***REMOVED***
    if (typeof file === 'string' && /***REMOVED***([^,]*?)***REMOVED***/g.test(file)) ***REMOVED***
      log.warn('invalid-glob-braces', [
        `The glob pattern $***REMOVED***dim(file)***REMOVED*** in your Tailwind CSS configuration is invalid.`,
        `Update it to $***REMOVED***dim(file.replace(/***REMOVED***([^,]*?)***REMOVED***/g, '$1'))***REMOVED*** to silence this warning.`,
        // TODO: Add https://tw.wtf/invalid-glob-braces
      ])
      break
***REMOVED***
***REMOVED***

  if (config.content.files.length === 0) ***REMOVED***
    log.warn('content-problems', [
      'The `content` option in your Tailwind CSS configuration is missing or empty.',
      'Configure your content sources or your generated CSS will be missing styles.',
      'https://tailwindcss.com/docs/content-configuration',
    ])
***REMOVED***

  return config
***REMOVED***

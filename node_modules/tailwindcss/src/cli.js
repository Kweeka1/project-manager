#!/usr/bin/env node

import ***REMOVED*** postcss, lazyCssnano, lazyAutoprefixer ***REMOVED*** from '../peers/index.js'

import chokidar from 'chokidar'
import path from 'path'
import arg from 'arg'
import fs from 'fs'
import postcssrc from 'postcss-load-config'
import ***REMOVED*** lilconfig ***REMOVED*** from 'lilconfig'
import loadPlugins from 'postcss-load-config/src/plugins' // Little bit scary, looking at private/internal API
import tailwind from './processTailwindFeatures'
import resolveConfigInternal from '../resolveConfig'
import fastGlob from 'fast-glob'
import getModuleDependencies from './lib/getModuleDependencies'
import log from './util/log'
import packageJson from '../package.json'
import normalizePath from 'normalize-path'

let env = ***REMOVED***
  DEBUG: process.env.DEBUG !== undefined && process.env.DEBUG !== '0',
***REMOVED***

// ---

function indentRecursive(node, indent = 0) ***REMOVED***
  node.each &&
    node.each((child, i) => ***REMOVED***
      if (!child.raws.before || !child.raws.before.trim() || child.raws.before.includes('\n')) ***REMOVED***
        child.raws.before = `\n$***REMOVED***node.type !== 'rule' && i > 0 ? '\n' : ''***REMOVED***$***REMOVED***'  '.repeat(indent)***REMOVED***`
  ***REMOVED***
      child.raws.after = `\n$***REMOVED***'  '.repeat(indent)***REMOVED***`
      indentRecursive(child, indent + 1)
***REMOVED***)
***REMOVED***

function formatNodes(root) ***REMOVED***
  indentRecursive(root)
  if (root.first) ***REMOVED***
    root.first.raws.before = ''
***REMOVED***
***REMOVED***

async function outputFile(file, contents) ***REMOVED***
  if (fs.existsSync(file) && (await fs.promises.readFile(file, 'utf8')) === contents) ***REMOVED***
    return // Skip writing the file
***REMOVED***

  // Write the file
  await fs.promises.writeFile(file, contents, 'utf8')
***REMOVED***

function drainStdin() ***REMOVED***
  return new Promise((resolve, reject) => ***REMOVED***
    let result = ''
    process.stdin.on('data', (chunk) => ***REMOVED***
      result += chunk
***REMOVED***)
    process.stdin.on('end', () => resolve(result))
    process.stdin.on('error', (err) => reject(err))
***REMOVED***)
***REMOVED***

function help(***REMOVED*** message, usage, commands, options ***REMOVED***) ***REMOVED***
  let indent = 2

  // Render header
  console.log()
  console.log(`$***REMOVED***packageJson.name***REMOVED*** v$***REMOVED***packageJson.version***REMOVED***`)

  // Render message
  if (message) ***REMOVED***
    console.log()
    for (let msg of message.split('\n')) ***REMOVED***
      console.log(msg)
***REMOVED***
***REMOVED***

  // Render usage
  if (usage && usage.length > 0) ***REMOVED***
    console.log()
    console.log('Usage:')
    for (let example of usage) ***REMOVED***
      console.log(' '.repeat(indent), example)
***REMOVED***
***REMOVED***

  // Render commands
  if (commands && commands.length > 0) ***REMOVED***
    console.log()
    console.log('Commands:')
    for (let command of commands) ***REMOVED***
      console.log(' '.repeat(indent), command)
***REMOVED***
***REMOVED***

  // Render options
  if (options) ***REMOVED***
    let groupedOptions = ***REMOVED******REMOVED***
    for (let [key, value] of Object.entries(options)) ***REMOVED***
      if (typeof value === 'object') ***REMOVED***
        groupedOptions[key] = ***REMOVED*** ...value, flags: [key] ***REMOVED***
  ***REMOVED*** else ***REMOVED***
        groupedOptions[value].flags.push(key)
  ***REMOVED***
***REMOVED***

    console.log()
    console.log('Options:')
    for (let ***REMOVED*** flags, description, deprecated ***REMOVED*** of Object.values(groupedOptions)) ***REMOVED***
      if (deprecated) continue

      if (flags.length === 1) ***REMOVED***
        console.log(
          ' '.repeat(indent + 4 /* 4 = "-i, ".length */),
          flags.slice().reverse().join(', ').padEnd(20, ' '),
          description
        )
  ***REMOVED*** else ***REMOVED***
        console.log(
          ' '.repeat(indent),
          flags.slice().reverse().join(', ').padEnd(24, ' '),
          description
        )
  ***REMOVED***
***REMOVED***
***REMOVED***

  console.log()
***REMOVED***

function oneOf(...options) ***REMOVED***
  return Object.assign(
    (value = true) => ***REMOVED***
      for (let option of options) ***REMOVED***
        let parsed = option(value)
        if (parsed === value) ***REMOVED***
          return parsed
    ***REMOVED***
  ***REMOVED***

      throw new Error('...')
***REMOVED***,
    ***REMOVED*** manualParsing: true ***REMOVED***
  )
***REMOVED***

let commands = ***REMOVED***
  init: ***REMOVED***
    run: init,
    args: ***REMOVED***
      '--full': ***REMOVED*** type: Boolean, description: 'Initialize a full `tailwind.config.js` file' ***REMOVED***,
      '--postcss': ***REMOVED*** type: Boolean, description: 'Initialize a `postcss.config.js` file' ***REMOVED***,
      '--types': ***REMOVED***
        type: Boolean,
        description: 'Add TypeScript types for the `tailwind.config.js` file',
  ***REMOVED***,
      '-f': '--full',
      '-p': '--postcss',
***REMOVED***,
***REMOVED***
  build: ***REMOVED***
    run: build,
    args: ***REMOVED***
      '--input': ***REMOVED*** type: String, description: 'Input file' ***REMOVED***,
      '--output': ***REMOVED*** type: String, description: 'Output file' ***REMOVED***,
      '--watch': ***REMOVED*** type: Boolean, description: 'Watch for changes and rebuild as needed' ***REMOVED***,
      /*
      '--poll': ***REMOVED***
        type: Boolean,
        description: 'Use polling instead of filesystem events when watching',
  ***REMOVED***,
      */
      '--content': ***REMOVED***
        type: String,
        description: 'Content paths to use for removing unused classes',
  ***REMOVED***,
      '--purge': ***REMOVED***
        type: String,
        deprecated: true,
  ***REMOVED***,
      '--postcss': ***REMOVED***
        type: oneOf(String, Boolean),
        description: 'Load custom PostCSS configuration',
  ***REMOVED***,
      '--minify': ***REMOVED*** type: Boolean, description: 'Minify the output' ***REMOVED***,
      '--config': ***REMOVED***
        type: String,
        description: 'Path to a custom config file',
  ***REMOVED***,
      '--no-autoprefixer': ***REMOVED***
        type: Boolean,
        description: 'Disable autoprefixer',
  ***REMOVED***,
      '-c': '--config',
      '-i': '--input',
      '-o': '--output',
      '-m': '--minify',
      '-w': '--watch',
      /*
      '-p': '--poll',
      */
***REMOVED***,
***REMOVED***
***REMOVED***

let sharedFlags = ***REMOVED***
  '--help': ***REMOVED*** type: Boolean, description: 'Display usage information' ***REMOVED***,
  '-h': '--help',
***REMOVED***

if (
  process.stdout.isTTY /* Detect redirecting output to a file */ &&
  (process.argv[2] === undefined ||
    process.argv.slice(2).every((flag) => sharedFlags[flag] !== undefined))
) ***REMOVED***
  help(***REMOVED***
    usage: [
      'tailwindcss [--input input.css] [--output output.css] [--watch] [options...]',
      'tailwindcss init [--full] [--postcss] [--types] [options...]',
    ],
    commands: Object.keys(commands)
      .filter((command) => command !== 'build')
      .map((command) => `$***REMOVED***command***REMOVED*** [options]`),
    options: ***REMOVED*** ...commands.build.args, ...sharedFlags ***REMOVED***,
***REMOVED***)
  process.exit(0)
***REMOVED***

let command = ((arg = '') => (arg.startsWith('-') ? undefined : arg))(process.argv[2]) || 'build'

if (commands[command] === undefined) ***REMOVED***
  if (fs.existsSync(path.resolve(command))) ***REMOVED***
    // TODO: Deprecate this in future versions
    // Check if non-existing command, might be a file.
    command = 'build'
***REMOVED*** else ***REMOVED***
    help(***REMOVED***
      message: `Invalid command: $***REMOVED***command***REMOVED***`,
      usage: ['tailwindcss <command> [options]'],
      commands: Object.keys(commands)
        .filter((command) => command !== 'build')
        .map((command) => `$***REMOVED***command***REMOVED*** [options]`),
      options: sharedFlags,
***REMOVED***)
    process.exit(1)
***REMOVED***
***REMOVED***

// Execute command
let ***REMOVED*** args: flags, run ***REMOVED*** = commands[command]
let args = (() => ***REMOVED***
  try ***REMOVED***
    let result = arg(
      Object.fromEntries(
        Object.entries(***REMOVED*** ...flags, ...sharedFlags ***REMOVED***)
          .filter(([_key, value]) => !value?.type?.manualParsing)
          .map(([key, value]) => [key, typeof value === 'object' ? value.type : value])
      ),
      ***REMOVED*** permissive: true ***REMOVED***
    )

    // Manual parsing of flags to allow for special flags like oneOf(Boolean, String)
    for (let i = result['_'].length - 1; i >= 0; --i) ***REMOVED***
      let flag = result['_'][i]
      if (!flag.startsWith('-')) continue

      let flagName = flag
      let handler = flags[flag]

      // Resolve flagName & handler
      while (typeof handler === 'string') ***REMOVED***
        flagName = handler
        handler = flags[handler]
  ***REMOVED***

      if (!handler) continue

      let args = []
      let offset = i + 1

      // Parse args for current flag
      while (result['_'][offset] && !result['_'][offset].startsWith('-')) ***REMOVED***
        args.push(result['_'][offset++])
  ***REMOVED***

      // Cleanup manually parsed flags + args
      result['_'].splice(i, 1 + args.length)

      // Set the resolved value in the `result` object
      result[flagName] = handler.type(
        args.length === 0 ? undefined : args.length === 1 ? args[0] : args,
        flagName
      )
***REMOVED***

    // Ensure that the `command` is always the first argument in the `args`.
    // This is important so that we don't have to check if a default command
    // (build) was used or not from within each plugin.
    //
    // E.g.: tailwindcss input.css -> _: ['build', 'input.css']
    // E.g.: tailwindcss build input.css -> _: ['build', 'input.css']
    if (result['_'][0] !== command) ***REMOVED***
      result['_'].unshift(command)
***REMOVED***

    return result
***REMOVED*** catch (err) ***REMOVED***
    if (err.code === 'ARG_UNKNOWN_OPTION') ***REMOVED***
      help(***REMOVED***
        message: err.message,
        usage: ['tailwindcss <command> [options]'],
        options: sharedFlags,
  ***REMOVED***)
      process.exit(1)
***REMOVED***
    throw err
***REMOVED***
***REMOVED***)()

if (args['--help']) ***REMOVED***
  help(***REMOVED***
    options: ***REMOVED*** ...flags, ...sharedFlags ***REMOVED***,
    usage: [`tailwindcss $***REMOVED***command***REMOVED*** [options]`],
***REMOVED***)
  process.exit(0)
***REMOVED***

run()

// ---

function init() ***REMOVED***
  let messages = []

  let tailwindConfigLocation = path.resolve(args['_'][1] ?? './tailwind.config.js')
  if (fs.existsSync(tailwindConfigLocation)) ***REMOVED***
    messages.push(`$***REMOVED***path.basename(tailwindConfigLocation)***REMOVED*** already exists.`)
***REMOVED*** else ***REMOVED***
    let stubFile = fs.readFileSync(
      args['--full']
        ? path.resolve(__dirname, '../stubs/defaultConfig.stub.js')
        : path.resolve(__dirname, '../stubs/simpleConfig.stub.js'),
      'utf8'
    )

    if (args['--types']) ***REMOVED***
      let typesHeading = "/** @type ***REMOVED***import('tailwindcss/types').Config***REMOVED*** */"
      stubFile =
        stubFile.replace(`module.exports = `, `$***REMOVED***typesHeading***REMOVED***\nconst config = `) +
        '\nmodule.exports = config'
***REMOVED***

    // Change colors import
    stubFile = stubFile.replace('../colors', 'tailwindcss/colors')

    fs.writeFileSync(tailwindConfigLocation, stubFile, 'utf8')

    messages.push(`Created Tailwind CSS config file: $***REMOVED***path.basename(tailwindConfigLocation)***REMOVED***`)
***REMOVED***

  if (args['--postcss']) ***REMOVED***
    let postcssConfigLocation = path.resolve('./postcss.config.js')
    if (fs.existsSync(postcssConfigLocation)) ***REMOVED***
      messages.push(`$***REMOVED***path.basename(postcssConfigLocation)***REMOVED*** already exists.`)
***REMOVED*** else ***REMOVED***
      let stubFile = fs.readFileSync(
        path.resolve(__dirname, '../stubs/defaultPostCssConfig.stub.js'),
        'utf8'
      )

      fs.writeFileSync(postcssConfigLocation, stubFile, 'utf8')

      messages.push(`Created PostCSS config file: $***REMOVED***path.basename(postcssConfigLocation)***REMOVED***`)
***REMOVED***
***REMOVED***

  if (messages.length > 0) ***REMOVED***
    console.log()
    for (let message of messages) ***REMOVED***
      console.log(message)
***REMOVED***
***REMOVED***
***REMOVED***

async function build() ***REMOVED***
  let input = args['--input']
  let output = args['--output']
  let shouldWatch = args['--watch']
  let shouldPoll = false
  /*
  let shouldPoll = args['--poll']
  */
  let shouldCoalesceWriteEvents = shouldPoll || process.platform === 'win32'
  let includePostCss = args['--postcss']

  // Polling interval in milliseconds
  // Used only when polling or coalescing add/change events on Windows
  let pollInterval = 10

  // TODO: Deprecate this in future versions
  if (!input && args['_'][1]) ***REMOVED***
    console.error('[deprecation] Running tailwindcss without -i, please provide an input file.')
    input = args['--input'] = args['_'][1]
***REMOVED***

  if (input && input !== '-' && !fs.existsSync((input = path.resolve(input)))) ***REMOVED***
    console.error(`Specified input file $***REMOVED***args['--input']***REMOVED*** does not exist.`)
    process.exit(9)
***REMOVED***

  if (args['--config'] && !fs.existsSync((args['--config'] = path.resolve(args['--config'])))) ***REMOVED***
    console.error(`Specified config file $***REMOVED***args['--config']***REMOVED*** does not exist.`)
    process.exit(9)
***REMOVED***

  let configPath = args['--config']
    ? args['--config']
    : ((defaultPath) => (fs.existsSync(defaultPath) ? defaultPath : null))(
        path.resolve('./tailwind.config.js')
      )

  async function loadPostCssPlugins() ***REMOVED***
    let customPostCssPath = typeof args['--postcss'] === 'string' ? args['--postcss'] : undefined
    let ***REMOVED*** plugins: configPlugins ***REMOVED*** = customPostCssPath
      ? await (async () => ***REMOVED***
          let file = path.resolve(customPostCssPath)

          // Implementation, see: https://unpkg.com/browse/postcss-load-config@3.1.0/src/index.js
          let ***REMOVED*** config = ***REMOVED******REMOVED*** ***REMOVED*** = await lilconfig('postcss').load(file)
          if (typeof config === 'function') ***REMOVED***
            config = config()
      ***REMOVED*** else ***REMOVED***
            config = Object.assign(***REMOVED******REMOVED***, config)
      ***REMOVED***

          if (!config.plugins) ***REMOVED***
            config.plugins = []
      ***REMOVED***

          return ***REMOVED*** plugins: loadPlugins(config, file) ***REMOVED***
    ***REMOVED***)()
      : await postcssrc()

    let configPluginTailwindIdx = configPlugins.findIndex((plugin) => ***REMOVED***
      if (typeof plugin === 'function' && plugin.name === 'tailwindcss') ***REMOVED***
        return true
  ***REMOVED***

      if (typeof plugin === 'object' && plugin !== null && plugin.postcssPlugin === 'tailwindcss') ***REMOVED***
        return true
  ***REMOVED***

      return false
***REMOVED***)

    let beforePlugins =
      configPluginTailwindIdx === -1 ? [] : configPlugins.slice(0, configPluginTailwindIdx)
    let afterPlugins =
      configPluginTailwindIdx === -1
        ? configPlugins
        : configPlugins.slice(configPluginTailwindIdx + 1)

    return [beforePlugins, afterPlugins]
***REMOVED***

  function resolveConfig() ***REMOVED***
    let config = configPath ? require(configPath) : ***REMOVED******REMOVED***

    if (args['--purge']) ***REMOVED***
      log.warn('purge-flag-deprecated', [
        'The `--purge` flag has been deprecated.',
        'Please use `--content` instead.',
      ])
      if (!args['--content']) ***REMOVED***
        args['--content'] = args['--purge']
  ***REMOVED***
***REMOVED***

    if (args['--content']) ***REMOVED***
      let files = args['--content'].split(/(?<!***REMOVED***[^***REMOVED***]+),/)
      let resolvedConfig = resolveConfigInternal(config, ***REMOVED*** content: ***REMOVED*** files ***REMOVED*** ***REMOVED***)
      resolvedConfig.content.files = files
      return resolvedConfig
***REMOVED***

    return resolveConfigInternal(config)
***REMOVED***

  function extractFileGlobs(config) ***REMOVED***
    return config.content.files
      .filter((file) => ***REMOVED***
        // Strings in this case are files / globs. If it is something else,
        // like an object it's probably a raw content object. But this object
        // is not watchable, so let's remove it.
        return typeof file === 'string'
  ***REMOVED***)
      .map((glob) => normalizePath(glob))
***REMOVED***

  function extractRawContent(config) ***REMOVED***
    return config.content.files.filter((file) => ***REMOVED***
      return typeof file === 'object' && file !== null
***REMOVED***)
***REMOVED***

  function getChangedContent(config) ***REMOVED***
    let changedContent = []

    // Resolve globs from the content config
    let globs = extractFileGlobs(config)
    let files = fastGlob.sync(globs)

    for (let file of files) ***REMOVED***
      changedContent.push(***REMOVED***
        content: fs.readFileSync(path.resolve(file), 'utf8'),
        extension: path.extname(file).slice(1),
  ***REMOVED***)
***REMOVED***

    // Resolve raw content in the tailwind config
    for (let ***REMOVED*** raw: content, extension = 'html' ***REMOVED*** of extractRawContent(config)) ***REMOVED***
      changedContent.push(***REMOVED*** content, extension ***REMOVED***)
***REMOVED***

    return changedContent
***REMOVED***

  async function buildOnce() ***REMOVED***
    let config = resolveConfig()
    let changedContent = getChangedContent(config)

    let tailwindPlugin = () => ***REMOVED***
      return ***REMOVED***
        postcssPlugin: 'tailwindcss',
        Once(root, ***REMOVED*** result ***REMOVED***) ***REMOVED***
          tailwind((***REMOVED*** createContext ***REMOVED***) => ***REMOVED***
            return () => ***REMOVED***
              return createContext(config, changedContent)
        ***REMOVED***
      ***REMOVED***)(root, result)
    ***REMOVED***,
  ***REMOVED***
***REMOVED***

    tailwindPlugin.postcss = true

    let [beforePlugins, afterPlugins] = includePostCss ? await loadPostCssPlugins() : [[], []]

    let plugins = [
      ...beforePlugins,
      tailwindPlugin,
      !args['--minify'] && formatNodes,
      ...afterPlugins,
      !args['--no-autoprefixer'] &&
        (() => ***REMOVED***
          // Try to load a local `autoprefixer` version first
          try ***REMOVED***
            return require('autoprefixer')
      ***REMOVED*** catch ***REMOVED******REMOVED***

          return lazyAutoprefixer()
    ***REMOVED***)(),
      args['--minify'] &&
        (() => ***REMOVED***
          let options = ***REMOVED*** preset: ['default', ***REMOVED*** cssDeclarationSorter: false ***REMOVED***] ***REMOVED***

          // Try to load a local `cssnano` version first
          try ***REMOVED***
            return require('cssnano')
      ***REMOVED*** catch ***REMOVED******REMOVED***

          return lazyCssnano()(options)
    ***REMOVED***)(),
    ].filter(Boolean)

    let processor = postcss(plugins)

    function processCSS(css) ***REMOVED***
      let start = process.hrtime.bigint()
      return Promise.resolve()
        .then(() => (output ? fs.promises.mkdir(path.dirname(output), ***REMOVED*** recursive: true ***REMOVED***) : null))
        .then(() => processor.process(css, ***REMOVED*** from: input, to: output ***REMOVED***))
        .then((result) => ***REMOVED***
          if (!output) ***REMOVED***
            return process.stdout.write(result.css)
      ***REMOVED***

          return Promise.all(
            [
              outputFile(output, result.css),
              result.map && outputFile(output + '.map', result.map.toString()),
            ].filter(Boolean)
          )
    ***REMOVED***)
        .then(() => ***REMOVED***
          let end = process.hrtime.bigint()
          console.error()
          console.error('Done in', (end - start) / BigInt(1e6) + 'ms.')
    ***REMOVED***)
***REMOVED***

    let css = await (() => ***REMOVED***
      // Piping in data, let's drain the stdin
      if (input === '-') ***REMOVED***
        return drainStdin()
  ***REMOVED***

      // Input file has been provided
      if (input) ***REMOVED***
        return fs.readFileSync(path.resolve(input), 'utf8')
  ***REMOVED***

      // No input file provided, fallback to default atrules
      return '@tailwind base; @tailwind components; @tailwind utilities'
***REMOVED***)()

    return processCSS(css)
***REMOVED***

  let context = null

  async function startWatcher() ***REMOVED***
    let changedContent = []
    let configDependencies = []
    let contextDependencies = new Set()
    let watcher = null

    function refreshConfig() ***REMOVED***
      env.DEBUG && console.time('Module dependencies')
      for (let file of configDependencies) ***REMOVED***
        delete require.cache[require.resolve(file)]
  ***REMOVED***

      if (configPath) ***REMOVED***
        configDependencies = getModuleDependencies(configPath).map((***REMOVED*** file ***REMOVED***) => file)

        for (let dependency of configDependencies) ***REMOVED***
          contextDependencies.add(dependency)
    ***REMOVED***
  ***REMOVED***
      env.DEBUG && console.timeEnd('Module dependencies')

      return resolveConfig()
***REMOVED***

    let [beforePlugins, afterPlugins] = includePostCss ? await loadPostCssPlugins() : [[], []]

    let plugins = [
      ...beforePlugins,
      '__TAILWIND_PLUGIN_POSITION__',
      !args['--minify'] && formatNodes,
      ...afterPlugins,
      !args['--no-autoprefixer'] &&
        (() => ***REMOVED***
          // Try to load a local `autoprefixer` version first
          try ***REMOVED***
            return require('autoprefixer')
      ***REMOVED*** catch ***REMOVED******REMOVED***

          return lazyAutoprefixer()
    ***REMOVED***)(),
      args['--minify'] &&
        (() => ***REMOVED***
          let options = ***REMOVED*** preset: ['default', ***REMOVED*** cssDeclarationSorter: false ***REMOVED***] ***REMOVED***

          // Try to load a local `cssnano` version first
          try ***REMOVED***
            return require('cssnano')
      ***REMOVED*** catch ***REMOVED******REMOVED***

          return lazyCssnano()(options)
    ***REMOVED***)(),
    ].filter(Boolean)

    async function rebuild(config) ***REMOVED***
      env.DEBUG && console.time('Finished in')

      let tailwindPlugin = () => ***REMOVED***
        return ***REMOVED***
          postcssPlugin: 'tailwindcss',
          Once(root, ***REMOVED*** result ***REMOVED***) ***REMOVED***
            env.DEBUG && console.time('Compiling CSS')
            tailwind((***REMOVED*** createContext ***REMOVED***) => ***REMOVED***
              console.error()
              console.error('Rebuilding...')

              return () => ***REMOVED***
                if (context !== null) ***REMOVED***
                  context.changedContent = changedContent.splice(0)
                  return context
            ***REMOVED***

                env.DEBUG && console.time('Creating context')
                context = createContext(config, changedContent.splice(0))
                env.DEBUG && console.timeEnd('Creating context')
                return context
          ***REMOVED***
        ***REMOVED***)(root, result)
            env.DEBUG && console.timeEnd('Compiling CSS')
      ***REMOVED***,
    ***REMOVED***
  ***REMOVED***

      tailwindPlugin.postcss = true

      let tailwindPluginIdx = plugins.indexOf('__TAILWIND_PLUGIN_POSITION__')
      let copy = plugins.slice()
      copy.splice(tailwindPluginIdx, 1, tailwindPlugin)
      let processor = postcss(copy)

      function processCSS(css) ***REMOVED***
        let start = process.hrtime.bigint()
        return Promise.resolve()
          .then(() =>
            output ? fs.promises.mkdir(path.dirname(output), ***REMOVED*** recursive: true ***REMOVED***) : null
          )
          .then(() => processor.process(css, ***REMOVED*** from: input, to: output ***REMOVED***))
          .then(async (result) => ***REMOVED***
            for (let message of result.messages) ***REMOVED***
              if (message.type === 'dependency') ***REMOVED***
                contextDependencies.add(message.file)
          ***REMOVED***
        ***REMOVED***
            watcher.add([...contextDependencies])

            if (!output) ***REMOVED***
              return process.stdout.write(result.css)
        ***REMOVED***

            return Promise.all(
              [
                outputFile(output, result.css),
                result.map && outputFile(output + '.map', result.map.toString()),
              ].filter(Boolean)
            )
      ***REMOVED***)
          .then(() => ***REMOVED***
            let end = process.hrtime.bigint()
            console.error('Done in', (end - start) / BigInt(1e6) + 'ms.')
      ***REMOVED***)
          .catch((err) => ***REMOVED***
            if (err.name === 'CssSyntaxError') ***REMOVED***
              console.error(err.toString())
        ***REMOVED*** else ***REMOVED***
              console.error(err)
        ***REMOVED***
      ***REMOVED***)
  ***REMOVED***

      let css = await (() => ***REMOVED***
        // Piping in data, let's drain the stdin
        if (input === '-') ***REMOVED***
          return drainStdin()
    ***REMOVED***

        // Input file has been provided
        if (input) ***REMOVED***
          return fs.readFileSync(path.resolve(input), 'utf8')
    ***REMOVED***

        // No input file provided, fallback to default atrules
        return '@tailwind base; @tailwind components; @tailwind utilities'
  ***REMOVED***)()

      let result = await processCSS(css)
      env.DEBUG && console.timeEnd('Finished in')
      return result
***REMOVED***

    let config = refreshConfig(configPath)

    if (input) ***REMOVED***
      contextDependencies.add(path.resolve(input))
***REMOVED***

    watcher = chokidar.watch([...contextDependencies, ...extractFileGlobs(config)], ***REMOVED***
      usePolling: shouldPoll,
      interval: shouldPoll ? pollInterval : undefined,
      ignoreInitial: true,
      awaitWriteFinish: shouldCoalesceWriteEvents
        ? ***REMOVED***
            stabilityThreshold: 50,
            pollInterval: pollInterval,
      ***REMOVED***
        : false,
***REMOVED***)

    let chain = Promise.resolve()

    watcher.on('change', async (file) => ***REMOVED***
      if (contextDependencies.has(file)) ***REMOVED***
        env.DEBUG && console.time('Resolve config')
        context = null
        config = refreshConfig(configPath)
        env.DEBUG && console.timeEnd('Resolve config')

        env.DEBUG && console.time('Watch new files')
        let globs = extractFileGlobs(config)
        watcher.add(configDependencies)
        watcher.add(globs)
        env.DEBUG && console.timeEnd('Watch new files')

        chain = chain.then(async () => ***REMOVED***
          changedContent.push(...getChangedContent(config))
          await rebuild(config)
    ***REMOVED***)
  ***REMOVED*** else ***REMOVED***
        chain = chain.then(async () => ***REMOVED***
          changedContent.push(***REMOVED***
            content: fs.readFileSync(path.resolve(file), 'utf8'),
            extension: path.extname(file).slice(1),
      ***REMOVED***)

          await rebuild(config)
    ***REMOVED***)
  ***REMOVED***
***REMOVED***)

    watcher.on('add', async (file) => ***REMOVED***
      chain = chain.then(async () => ***REMOVED***
        changedContent.push(***REMOVED***
          content: fs.readFileSync(path.resolve(file), 'utf8'),
          extension: path.extname(file).slice(1),
    ***REMOVED***)

        await rebuild(config)
  ***REMOVED***)
***REMOVED***)

    chain = chain.then(() => ***REMOVED***
      changedContent.push(...getChangedContent(config))
      return rebuild(config)
***REMOVED***)
***REMOVED***

  if (shouldWatch) ***REMOVED***
    /* Abort the watcher if stdin is closed to avoid zombie processes */
    process.stdin.on('end', () => process.exit(0))
    process.stdin.resume()
    startWatcher()
***REMOVED*** else ***REMOVED***
    buildOnce()
***REMOVED***
***REMOVED***

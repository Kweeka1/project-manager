var path = require('path');
var test = require('tape');
var resolve = require('../');

test('mock', function (t) ***REMOVED***
    t.plan(8);

    var files = ***REMOVED******REMOVED***;
    files[path.resolve('/foo/bar/baz.js')] = 'beep';

    var dirs = ***REMOVED******REMOVED***;
    dirs[path.resolve('/foo/bar')] = true;

    function opts(basedir) ***REMOVED***
        return ***REMOVED***
            basedir: path.resolve(basedir),
            isFile: function (file, cb) ***REMOVED***
                cb(null, Object.prototype.hasOwnProperty.call(files, path.resolve(file)));
        ***REMOVED***,
            isDirectory: function (dir, cb) ***REMOVED***
                cb(null, !!dirs[path.resolve(dir)]);
        ***REMOVED***,
            readFile: function (file, cb) ***REMOVED***
                cb(null, files[path.resolve(file)]);
        ***REMOVED***,
            realpath: function (file, cb) ***REMOVED***
                cb(null, file);
        ***REMOVED***
    ***REMOVED***;
***REMOVED***

    resolve('./baz', opts('/foo/bar'), function (err, res, pkg) ***REMOVED***
        if (err) return t.fail(err);
        t.equal(res, path.resolve('/foo/bar/baz.js'));
        t.equal(pkg, undefined);
***REMOVED***);

    resolve('./baz.js', opts('/foo/bar'), function (err, res, pkg) ***REMOVED***
        if (err) return t.fail(err);
        t.equal(res, path.resolve('/foo/bar/baz.js'));
        t.equal(pkg, undefined);
***REMOVED***);

    resolve('baz', opts('/foo/bar'), function (err, res) ***REMOVED***
        t.equal(err.message, "Cannot find module 'baz' from '" + path.resolve('/foo/bar') + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
***REMOVED***);

    resolve('../baz', opts('/foo/bar'), function (err, res) ***REMOVED***
        t.equal(err.message, "Cannot find module '../baz' from '" + path.resolve('/foo/bar') + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
***REMOVED***);
***REMOVED***);

test('mock from package', function (t) ***REMOVED***
    t.plan(8);

    var files = ***REMOVED******REMOVED***;
    files[path.resolve('/foo/bar/baz.js')] = 'beep';

    var dirs = ***REMOVED******REMOVED***;
    dirs[path.resolve('/foo/bar')] = true;

    function opts(basedir) ***REMOVED***
        return ***REMOVED***
            basedir: path.resolve(basedir),
            isFile: function (file, cb) ***REMOVED***
                cb(null, Object.prototype.hasOwnProperty.call(files, file));
        ***REMOVED***,
            isDirectory: function (dir, cb) ***REMOVED***
                cb(null, !!dirs[path.resolve(dir)]);
        ***REMOVED***,
            'package': ***REMOVED*** main: 'bar' ***REMOVED***,
            readFile: function (file, cb) ***REMOVED***
                cb(null, files[file]);
        ***REMOVED***,
            realpath: function (file, cb) ***REMOVED***
                cb(null, file);
        ***REMOVED***
    ***REMOVED***;
***REMOVED***

    resolve('./baz', opts('/foo/bar'), function (err, res, pkg) ***REMOVED***
        if (err) return t.fail(err);
        t.equal(res, path.resolve('/foo/bar/baz.js'));
        t.equal(pkg && pkg.main, 'bar');
***REMOVED***);

    resolve('./baz.js', opts('/foo/bar'), function (err, res, pkg) ***REMOVED***
        if (err) return t.fail(err);
        t.equal(res, path.resolve('/foo/bar/baz.js'));
        t.equal(pkg && pkg.main, 'bar');
***REMOVED***);

    resolve('baz', opts('/foo/bar'), function (err, res) ***REMOVED***
        t.equal(err.message, "Cannot find module 'baz' from '" + path.resolve('/foo/bar') + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
***REMOVED***);

    resolve('../baz', opts('/foo/bar'), function (err, res) ***REMOVED***
        t.equal(err.message, "Cannot find module '../baz' from '" + path.resolve('/foo/bar') + "'");
        t.equal(err.code, 'MODULE_NOT_FOUND');
***REMOVED***);
***REMOVED***);

test('mock package', function (t) ***REMOVED***
    t.plan(2);

    var files = ***REMOVED******REMOVED***;
    files[path.resolve('/foo/node_modules/bar/baz.js')] = 'beep';
    files[path.resolve('/foo/node_modules/bar/package.json')] = JSON.stringify(***REMOVED***
        main: './baz.js'
***REMOVED***);

    var dirs = ***REMOVED******REMOVED***;
    dirs[path.resolve('/foo')] = true;
    dirs[path.resolve('/foo/node_modules')] = true;

    function opts(basedir) ***REMOVED***
        return ***REMOVED***
            basedir: path.resolve(basedir),
            isFile: function (file, cb) ***REMOVED***
                cb(null, Object.prototype.hasOwnProperty.call(files, path.resolve(file)));
        ***REMOVED***,
            isDirectory: function (dir, cb) ***REMOVED***
                cb(null, !!dirs[path.resolve(dir)]);
        ***REMOVED***,
            readFile: function (file, cb) ***REMOVED***
                cb(null, files[path.resolve(file)]);
        ***REMOVED***,
            realpath: function (file, cb) ***REMOVED***
                cb(null, file);
        ***REMOVED***
    ***REMOVED***;
***REMOVED***

    resolve('bar', opts('/foo'), function (err, res, pkg) ***REMOVED***
        if (err) return t.fail(err);
        t.equal(res, path.resolve('/foo/node_modules/bar/baz.js'));
        t.equal(pkg && pkg.main, './baz.js');
***REMOVED***);
***REMOVED***);

test('mock package from package', function (t) ***REMOVED***
    t.plan(2);

    var files = ***REMOVED******REMOVED***;
    files[path.resolve('/foo/node_modules/bar/baz.js')] = 'beep';
    files[path.resolve('/foo/node_modules/bar/package.json')] = JSON.stringify(***REMOVED***
        main: './baz.js'
***REMOVED***);

    var dirs = ***REMOVED******REMOVED***;
    dirs[path.resolve('/foo')] = true;
    dirs[path.resolve('/foo/node_modules')] = true;

    function opts(basedir) ***REMOVED***
        return ***REMOVED***
            basedir: path.resolve(basedir),
            isFile: function (file, cb) ***REMOVED***
                cb(null, Object.prototype.hasOwnProperty.call(files, path.resolve(file)));
        ***REMOVED***,
            isDirectory: function (dir, cb) ***REMOVED***
                cb(null, !!dirs[path.resolve(dir)]);
        ***REMOVED***,
            'package': ***REMOVED*** main: 'bar' ***REMOVED***,
            readFile: function (file, cb) ***REMOVED***
                cb(null, files[path.resolve(file)]);
        ***REMOVED***,
            realpath: function (file, cb) ***REMOVED***
                cb(null, file);
        ***REMOVED***
    ***REMOVED***;
***REMOVED***

    resolve('bar', opts('/foo'), function (err, res, pkg) ***REMOVED***
        if (err) return t.fail(err);
        t.equal(res, path.resolve('/foo/node_modules/bar/baz.js'));
        t.equal(pkg && pkg.main, './baz.js');
***REMOVED***);
***REMOVED***);

test('symlinked', function (t) ***REMOVED***
    t.plan(4);

    var files = ***REMOVED******REMOVED***;
    files[path.resolve('/foo/bar/baz.js')] = 'beep';
    files[path.resolve('/foo/bar/symlinked/baz.js')] = 'beep';

    var dirs = ***REMOVED******REMOVED***;
    dirs[path.resolve('/foo/bar')] = true;
    dirs[path.resolve('/foo/bar/symlinked')] = true;

    function opts(basedir) ***REMOVED***
        return ***REMOVED***
            preserveSymlinks: false,
            basedir: path.resolve(basedir),
            isFile: function (file, cb) ***REMOVED***
                cb(null, Object.prototype.hasOwnProperty.call(files, path.resolve(file)));
        ***REMOVED***,
            isDirectory: function (dir, cb) ***REMOVED***
                cb(null, !!dirs[path.resolve(dir)]);
        ***REMOVED***,
            readFile: function (file, cb) ***REMOVED***
                cb(null, files[path.resolve(file)]);
        ***REMOVED***,
            realpath: function (file, cb) ***REMOVED***
                var resolved = path.resolve(file);

                if (resolved.indexOf('symlinked') >= 0) ***REMOVED***
                    cb(null, resolved);
                    return;
            ***REMOVED***

                var ext = path.extname(resolved);

                if (ext) ***REMOVED***
                    var dir = path.dirname(resolved);
                    var base = path.basename(resolved);
                    cb(null, path.join(dir, 'symlinked', base));
            ***REMOVED*** else ***REMOVED***
                    cb(null, path.join(resolved, 'symlinked'));
            ***REMOVED***
        ***REMOVED***
    ***REMOVED***;
***REMOVED***

    resolve('./baz', opts('/foo/bar'), function (err, res, pkg) ***REMOVED***
        if (err) return t.fail(err);
        t.equal(res, path.resolve('/foo/bar/symlinked/baz.js'));
        t.equal(pkg, undefined);
***REMOVED***);

    resolve('./baz.js', opts('/foo/bar'), function (err, res, pkg) ***REMOVED***
        if (err) return t.fail(err);
        t.equal(res, path.resolve('/foo/bar/symlinked/baz.js'));
        t.equal(pkg, undefined);
***REMOVED***);
***REMOVED***);

test('readPackage', function (t) ***REMOVED***
    t.plan(3);

    var files = ***REMOVED******REMOVED***;
    files[path.resolve('/foo/node_modules/bar/something-else.js')] = 'beep';
    files[path.resolve('/foo/node_modules/bar/package.json')] = JSON.stringify(***REMOVED***
        main: './baz.js'
***REMOVED***);
    files[path.resolve('/foo/node_modules/bar/baz.js')] = 'boop';

    var dirs = ***REMOVED******REMOVED***;
    dirs[path.resolve('/foo')] = true;
    dirs[path.resolve('/foo/node_modules')] = true;

    function opts(basedir) ***REMOVED***
        return ***REMOVED***
            basedir: path.resolve(basedir),
            isFile: function (file, cb) ***REMOVED***
                cb(null, Object.prototype.hasOwnProperty.call(files, path.resolve(file)));
        ***REMOVED***,
            isDirectory: function (dir, cb) ***REMOVED***
                cb(null, !!dirs[path.resolve(dir)]);
        ***REMOVED***,
            'package': ***REMOVED*** main: 'bar' ***REMOVED***,
            readFile: function (file, cb) ***REMOVED***
                cb(null, files[path.resolve(file)]);
        ***REMOVED***,
            realpath: function (file, cb) ***REMOVED***
                cb(null, file);
        ***REMOVED***
    ***REMOVED***;
***REMOVED***

    t.test('with readFile', function (st) ***REMOVED***
        st.plan(3);

        resolve('bar', opts('/foo'), function (err, res, pkg) ***REMOVED***
            st.error(err);
            st.equal(res, path.resolve('/foo/node_modules/bar/baz.js'));
            st.equal(pkg && pkg.main, './baz.js');
    ***REMOVED***);
***REMOVED***);

    var readPackage = function (readFile, file, cb) ***REMOVED***
        var barPackage = path.join('bar', 'package.json');
        if (file.slice(-barPackage.length) === barPackage) ***REMOVED***
            cb(null, ***REMOVED*** main: './something-else.js' ***REMOVED***);
    ***REMOVED*** else ***REMOVED***
            cb(null, JSON.parse(files[path.resolve(file)]));
    ***REMOVED***
***REMOVED***;

    t.test('with readPackage', function (st) ***REMOVED***
        st.plan(3);

        var options = opts('/foo');
        delete options.readFile;
        options.readPackage = readPackage;
        resolve('bar', options, function (err, res, pkg) ***REMOVED***
            st.error(err);
            st.equal(res, path.resolve('/foo/node_modules/bar/something-else.js'));
            st.equal(pkg && pkg.main, './something-else.js');
    ***REMOVED***);
***REMOVED***);

    t.test('with readFile and readPackage', function (st) ***REMOVED***
        st.plan(1);

        var options = opts('/foo');
        options.readPackage = readPackage;
        resolve('bar', options, function (err) ***REMOVED***
            st.throws(function () ***REMOVED*** throw err; ***REMOVED***, TypeError, 'errors when both readFile and readPackage are provided');
    ***REMOVED***);
***REMOVED***);
***REMOVED***);

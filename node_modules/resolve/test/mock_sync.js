var path = require('path');
var test = require('tape');
var resolve = require('../');

test('mock', function (t) ***REMOVED***
    t.plan(4);

    var files = ***REMOVED******REMOVED***;
    files[path.resolve('/foo/bar/baz.js')] = 'beep';

    var dirs = ***REMOVED******REMOVED***;
    dirs[path.resolve('/foo/bar')] = true;

    function opts(basedir) ***REMOVED***
        return ***REMOVED***
            basedir: path.resolve(basedir),
            isFile: function (file) ***REMOVED***
                return Object.prototype.hasOwnProperty.call(files, path.resolve(file));
        ***REMOVED***,
            isDirectory: function (dir) ***REMOVED***
                return !!dirs[path.resolve(dir)];
        ***REMOVED***,
            readFileSync: function (file) ***REMOVED***
                return files[path.resolve(file)];
        ***REMOVED***,
            realpathSync: function (file) ***REMOVED***
                return file;
        ***REMOVED***
    ***REMOVED***;
***REMOVED***

    t.equal(
        resolve.sync('./baz', opts('/foo/bar')),
        path.resolve('/foo/bar/baz.js')
    );

    t.equal(
        resolve.sync('./baz.js', opts('/foo/bar')),
        path.resolve('/foo/bar/baz.js')
    );

    t.throws(function () ***REMOVED***
        resolve.sync('baz', opts('/foo/bar'));
***REMOVED***);

    t.throws(function () ***REMOVED***
        resolve.sync('../baz', opts('/foo/bar'));
***REMOVED***);
***REMOVED***);

test('mock package', function (t) ***REMOVED***
    t.plan(1);

    var files = ***REMOVED******REMOVED***;
    files[path.resolve('/foo/node_modules/bar/baz.js')] = 'beep';
    files[path.resolve('/foo/node_modules/bar/package.json')] = JSON.stringify(***REMOVED***
        main: './baz.js'
***REMOVED***);

    var dirs = ***REMOVED******REMOVED***;
    dirs[path.resolve('/foo')] = true;
    dirs[path.resolve('/foo/node_modules')] = true;

    function opts(basedir) ***REMOVED***
        return ***REMOVED***
            basedir: path.resolve(basedir),
            isFile: function (file) ***REMOVED***
                return Object.prototype.hasOwnProperty.call(files, path.resolve(file));
        ***REMOVED***,
            isDirectory: function (dir) ***REMOVED***
                return !!dirs[path.resolve(dir)];
        ***REMOVED***,
            readFileSync: function (file) ***REMOVED***
                return files[path.resolve(file)];
        ***REMOVED***,
            realpathSync: function (file) ***REMOVED***
                return file;
        ***REMOVED***
    ***REMOVED***;
***REMOVED***

    t.equal(
        resolve.sync('bar', opts('/foo')),
        path.resolve('/foo/node_modules/bar/baz.js')
    );
***REMOVED***);

test('symlinked', function (t) ***REMOVED***
    t.plan(2);

    var files = ***REMOVED******REMOVED***;
    files[path.resolve('/foo/bar/baz.js')] = 'beep';
    files[path.resolve('/foo/bar/symlinked/baz.js')] = 'beep';

    var dirs = ***REMOVED******REMOVED***;
    dirs[path.resolve('/foo/bar')] = true;
    dirs[path.resolve('/foo/bar/symlinked')] = true;

    function opts(basedir) ***REMOVED***
        return ***REMOVED***
            preserveSymlinks: false,
            basedir: path.resolve(basedir),
            isFile: function (file) ***REMOVED***
                return Object.prototype.hasOwnProperty.call(files, path.resolve(file));
        ***REMOVED***,
            isDirectory: function (dir) ***REMOVED***
                return !!dirs[path.resolve(dir)];
        ***REMOVED***,
            readFileSync: function (file) ***REMOVED***
                return files[path.resolve(file)];
        ***REMOVED***,
            realpathSync: function (file) ***REMOVED***
                var resolved = path.resolve(file);

                if (resolved.indexOf('symlinked') >= 0) ***REMOVED***
                    return resolved;
            ***REMOVED***

                var ext = path.extname(resolved);

                if (ext) ***REMOVED***
                    var dir = path.dirname(resolved);
                    var base = path.basename(resolved);
                    return path.join(dir, 'symlinked', base);
            ***REMOVED***
                return path.join(resolved, 'symlinked');
        ***REMOVED***
    ***REMOVED***;
***REMOVED***

    t.equal(
        resolve.sync('./baz', opts('/foo/bar')),
        path.resolve('/foo/bar/symlinked/baz.js')
    );

    t.equal(
        resolve.sync('./baz.js', opts('/foo/bar')),
        path.resolve('/foo/bar/symlinked/baz.js')
    );
***REMOVED***);

test('readPackageSync', function (t) ***REMOVED***
    t.plan(3);

    var files = ***REMOVED******REMOVED***;
    files[path.resolve('/foo/node_modules/bar/something-else.js')] = 'beep';
    files[path.resolve('/foo/node_modules/bar/package.json')] = JSON.stringify(***REMOVED***
        main: './baz.js'
***REMOVED***);
    files[path.resolve('/foo/node_modules/bar/baz.js')] = 'boop';

    var dirs = ***REMOVED******REMOVED***;
    dirs[path.resolve('/foo')] = true;
    dirs[path.resolve('/foo/node_modules')] = true;

    function opts(basedir, useReadPackage) ***REMOVED***
        return ***REMOVED***
            basedir: path.resolve(basedir),
            isFile: function (file) ***REMOVED***
                return Object.prototype.hasOwnProperty.call(files, path.resolve(file));
        ***REMOVED***,
            isDirectory: function (dir) ***REMOVED***
                return !!dirs[path.resolve(dir)];
        ***REMOVED***,
            readFileSync: useReadPackage ? null : function (file) ***REMOVED***
                return files[path.resolve(file)];
        ***REMOVED***,
            realpathSync: function (file) ***REMOVED***
                return file;
        ***REMOVED***
    ***REMOVED***;
***REMOVED***
    t.test('with readFile', function (st) ***REMOVED***
        st.plan(1);

        st.equal(
            resolve.sync('bar', opts('/foo')),
            path.resolve('/foo/node_modules/bar/baz.js')
        );
***REMOVED***);

    var readPackageSync = function (readFileSync, file) ***REMOVED***
        if (file.indexOf(path.join('bar', 'package.json')) >= 0) ***REMOVED***
            return ***REMOVED*** main: './something-else.js' ***REMOVED***;
    ***REMOVED***
        return JSON.parse(files[path.resolve(file)]);
***REMOVED***;

    t.test('with readPackage', function (st) ***REMOVED***
        st.plan(1);

        var options = opts('/foo');
        delete options.readFileSync;
        options.readPackageSync = readPackageSync;

        st.equal(
            resolve.sync('bar', options),
            path.resolve('/foo/node_modules/bar/something-else.js')
        );
***REMOVED***);

    t.test('with readFile and readPackage', function (st) ***REMOVED***
        st.plan(1);

        var options = opts('/foo');
        options.readPackageSync = readPackageSync;
        st.throws(
            function () ***REMOVED*** resolve.sync('bar', options); ***REMOVED***,
            TypeError,
            'errors when both readFile and readPackage are provided'
        );
***REMOVED***);
***REMOVED***);


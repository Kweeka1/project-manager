'use strict'

let ***REMOVED*** SourceMapConsumer, SourceMapGenerator ***REMOVED*** = require('source-map-js')
let ***REMOVED*** existsSync, readFileSync ***REMOVED*** = require('fs')
let ***REMOVED*** dirname, join ***REMOVED*** = require('path')

function fromBase64(str) ***REMOVED***
  if (Buffer) ***REMOVED***
    return Buffer.from(str, 'base64').toString()
***REMOVED*** else ***REMOVED***
    /* c8 ignore next 2 */
    return window.atob(str)
***REMOVED***
***REMOVED***

class PreviousMap ***REMOVED***
  constructor(css, opts) ***REMOVED***
    if (opts.map === false) return
    this.loadAnnotation(css)
    this.inline = this.startWith(this.annotation, 'data:')

    let prev = opts.map ? opts.map.prev : undefined
    let text = this.loadMap(opts.from, prev)
    if (!this.mapFile && opts.from) ***REMOVED***
      this.mapFile = opts.from
***REMOVED***
    if (this.mapFile) this.root = dirname(this.mapFile)
    if (text) this.text = text
***REMOVED***

  consumer() ***REMOVED***
    if (!this.consumerCache) ***REMOVED***
      this.consumerCache = new SourceMapConsumer(this.text)
***REMOVED***
    return this.consumerCache
***REMOVED***

  withContent() ***REMOVED***
    return !!(
      this.consumer().sourcesContent &&
      this.consumer().sourcesContent.length > 0
    )
***REMOVED***

  startWith(string, start) ***REMOVED***
    if (!string) return false
    return string.substr(0, start.length) === start
***REMOVED***

  getAnnotationURL(sourceMapString) ***REMOVED***
    return sourceMapString.replace(/^\/\*\s*# sourceMappingURL=/, '').trim()
***REMOVED***

  loadAnnotation(css) ***REMOVED***
    let comments = css.match(/\/\*\s*# sourceMappingURL=/gm)
    if (!comments) return

    // sourceMappingURLs from comments, strings, etc.
    let start = css.lastIndexOf(comments.pop())
    let end = css.indexOf('*/', start)

    if (start > -1 && end > -1) ***REMOVED***
      // Locate the last sourceMappingURL to avoid pickin
      this.annotation = this.getAnnotationURL(css.substring(start, end))
***REMOVED***
***REMOVED***

  decodeInline(text) ***REMOVED***
    let baseCharsetUri = /^data:application\/json;charset=utf-?8;base64,/
    let baseUri = /^data:application\/json;base64,/
    let charsetUri = /^data:application\/json;charset=utf-?8,/
    let uri = /^data:application\/json,/

    if (charsetUri.test(text) || uri.test(text)) ***REMOVED***
      return decodeURIComponent(text.substr(RegExp.lastMatch.length))
***REMOVED***

    if (baseCharsetUri.test(text) || baseUri.test(text)) ***REMOVED***
      return fromBase64(text.substr(RegExp.lastMatch.length))
***REMOVED***

    let encoding = text.match(/data:application\/json;([^,]+),/)[1]
    throw new Error('Unsupported source map encoding ' + encoding)
***REMOVED***

  loadFile(path) ***REMOVED***
    this.root = dirname(path)
    if (existsSync(path)) ***REMOVED***
      this.mapFile = path
      return readFileSync(path, 'utf-8').toString().trim()
***REMOVED***
***REMOVED***

  loadMap(file, prev) ***REMOVED***
    if (prev === false) return false

    if (prev) ***REMOVED***
      if (typeof prev === 'string') ***REMOVED***
        return prev
  ***REMOVED*** else if (typeof prev === 'function') ***REMOVED***
        let prevPath = prev(file)
        if (prevPath) ***REMOVED***
          let map = this.loadFile(prevPath)
          if (!map) ***REMOVED***
            throw new Error(
              'Unable to load previous source map: ' + prevPath.toString()
            )
      ***REMOVED***
          return map
    ***REMOVED***
  ***REMOVED*** else if (prev instanceof SourceMapConsumer) ***REMOVED***
        return SourceMapGenerator.fromSourceMap(prev).toString()
  ***REMOVED*** else if (prev instanceof SourceMapGenerator) ***REMOVED***
        return prev.toString()
  ***REMOVED*** else if (this.isMap(prev)) ***REMOVED***
        return JSON.stringify(prev)
  ***REMOVED*** else ***REMOVED***
        throw new Error(
          'Unsupported previous source map format: ' + prev.toString()
        )
  ***REMOVED***
***REMOVED*** else if (this.inline) ***REMOVED***
      return this.decodeInline(this.annotation)
***REMOVED*** else if (this.annotation) ***REMOVED***
      let map = this.annotation
      if (file) map = join(dirname(file), map)
      return this.loadFile(map)
***REMOVED***
***REMOVED***

  isMap(map) ***REMOVED***
    if (typeof map !== 'object') return false
    return (
      typeof map.mappings === 'string' ||
      typeof map._mappings === 'string' ||
      Array.isArray(map.sections)
    )
***REMOVED***
***REMOVED***

module.exports = PreviousMap
PreviousMap.default = PreviousMap

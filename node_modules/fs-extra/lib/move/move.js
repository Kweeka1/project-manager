'use strict'

const fs = require('graceful-fs')
const path = require('path')
const copy = require('../copy').copy
const remove = require('../remove').remove
const mkdirp = require('../mkdirs').mkdirp
const pathExists = require('../path-exists').pathExists
const stat = require('../util/stat')

function move (src, dest, opts, cb) ***REMOVED***
  if (typeof opts === 'function') ***REMOVED***
    cb = opts
    opts = ***REMOVED******REMOVED***
***REMOVED***

  opts = opts || ***REMOVED******REMOVED***

  const overwrite = opts.overwrite || opts.clobber || false

  stat.checkPaths(src, dest, 'move', opts, (err, stats) => ***REMOVED***
    if (err) return cb(err)
    const ***REMOVED*** srcStat, isChangingCase = false ***REMOVED*** = stats
    stat.checkParentPaths(src, srcStat, dest, 'move', err => ***REMOVED***
      if (err) return cb(err)
      if (isParentRoot(dest)) return doRename(src, dest, overwrite, isChangingCase, cb)
      mkdirp(path.dirname(dest), err => ***REMOVED***
        if (err) return cb(err)
        return doRename(src, dest, overwrite, isChangingCase, cb)
  ***REMOVED***)
***REMOVED***)
***REMOVED***)
***REMOVED***

function isParentRoot (dest) ***REMOVED***
  const parent = path.dirname(dest)
  const parsedPath = path.parse(parent)
  return parsedPath.root === parent
***REMOVED***

function doRename (src, dest, overwrite, isChangingCase, cb) ***REMOVED***
  if (isChangingCase) return rename(src, dest, overwrite, cb)
  if (overwrite) ***REMOVED***
    return remove(dest, err => ***REMOVED***
      if (err) return cb(err)
      return rename(src, dest, overwrite, cb)
***REMOVED***)
***REMOVED***
  pathExists(dest, (err, destExists) => ***REMOVED***
    if (err) return cb(err)
    if (destExists) return cb(new Error('dest already exists.'))
    return rename(src, dest, overwrite, cb)
***REMOVED***)
***REMOVED***

function rename (src, dest, overwrite, cb) ***REMOVED***
  fs.rename(src, dest, err => ***REMOVED***
    if (!err) return cb()
    if (err.code !== 'EXDEV') return cb(err)
    return moveAcrossDevice(src, dest, overwrite, cb)
***REMOVED***)
***REMOVED***

function moveAcrossDevice (src, dest, overwrite, cb) ***REMOVED***
  const opts = ***REMOVED***
    overwrite,
    errorOnExist: true
***REMOVED***
  copy(src, dest, opts, err => ***REMOVED***
    if (err) return cb(err)
    return remove(src, cb)
***REMOVED***)
***REMOVED***

module.exports = move

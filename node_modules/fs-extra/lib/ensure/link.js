'use strict'

const u = require('universalify').fromCallback
const path = require('path')
const fs = require('graceful-fs')
const mkdir = require('../mkdirs')
const pathExists = require('../path-exists').pathExists
const ***REMOVED*** areIdentical ***REMOVED*** = require('../util/stat')

function createLink (srcpath, dstpath, callback) ***REMOVED***
  function makeLink (srcpath, dstpath) ***REMOVED***
    fs.link(srcpath, dstpath, err => ***REMOVED***
      if (err) return callback(err)
      callback(null)
***REMOVED***)
***REMOVED***

  fs.lstat(dstpath, (_, dstStat) => ***REMOVED***
    fs.lstat(srcpath, (err, srcStat) => ***REMOVED***
      if (err) ***REMOVED***
        err.message = err.message.replace('lstat', 'ensureLink')
        return callback(err)
  ***REMOVED***
      if (dstStat && areIdentical(srcStat, dstStat)) return callback(null)

      const dir = path.dirname(dstpath)
      pathExists(dir, (err, dirExists) => ***REMOVED***
        if (err) return callback(err)
        if (dirExists) return makeLink(srcpath, dstpath)
        mkdir.mkdirs(dir, err => ***REMOVED***
          if (err) return callback(err)
          makeLink(srcpath, dstpath)
    ***REMOVED***)
  ***REMOVED***)
***REMOVED***)
***REMOVED***)
***REMOVED***

function createLinkSync (srcpath, dstpath) ***REMOVED***
  let dstStat
  try ***REMOVED***
    dstStat = fs.lstatSync(dstpath)
***REMOVED*** catch ***REMOVED******REMOVED***

  try ***REMOVED***
    const srcStat = fs.lstatSync(srcpath)
    if (dstStat && areIdentical(srcStat, dstStat)) return
***REMOVED*** catch (err) ***REMOVED***
    err.message = err.message.replace('lstat', 'ensureLink')
    throw err
***REMOVED***

  const dir = path.dirname(dstpath)
  const dirExists = fs.existsSync(dir)
  if (dirExists) return fs.linkSync(srcpath, dstpath)
  mkdir.mkdirsSync(dir)

  return fs.linkSync(srcpath, dstpath)
***REMOVED***

module.exports = ***REMOVED***
  createLink: u(createLink),
  createLinkSync
***REMOVED***

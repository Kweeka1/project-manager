'use strict'

const u = require('universalify').fromCallback
const path = require('path')
const fs = require('../fs')
const _mkdirs = require('../mkdirs')
const mkdirs = _mkdirs.mkdirs
const mkdirsSync = _mkdirs.mkdirsSync

const _symlinkPaths = require('./symlink-paths')
const symlinkPaths = _symlinkPaths.symlinkPaths
const symlinkPathsSync = _symlinkPaths.symlinkPathsSync

const _symlinkType = require('./symlink-type')
const symlinkType = _symlinkType.symlinkType
const symlinkTypeSync = _symlinkType.symlinkTypeSync

const pathExists = require('../path-exists').pathExists

const ***REMOVED*** areIdentical ***REMOVED*** = require('../util/stat')

function createSymlink (srcpath, dstpath, type, callback) ***REMOVED***
  callback = (typeof type === 'function') ? type : callback
  type = (typeof type === 'function') ? false : type

  fs.lstat(dstpath, (err, stats) => ***REMOVED***
    if (!err && stats.isSymbolicLink()) ***REMOVED***
      Promise.all([
        fs.stat(srcpath),
        fs.stat(dstpath)
      ]).then(([srcStat, dstStat]) => ***REMOVED***
        if (areIdentical(srcStat, dstStat)) return callback(null)
        _createSymlink(srcpath, dstpath, type, callback)
  ***REMOVED***)
***REMOVED*** else _createSymlink(srcpath, dstpath, type, callback)
***REMOVED***)
***REMOVED***

function _createSymlink (srcpath, dstpath, type, callback) ***REMOVED***
  symlinkPaths(srcpath, dstpath, (err, relative) => ***REMOVED***
    if (err) return callback(err)
    srcpath = relative.toDst
    symlinkType(relative.toCwd, type, (err, type) => ***REMOVED***
      if (err) return callback(err)
      const dir = path.dirname(dstpath)
      pathExists(dir, (err, dirExists) => ***REMOVED***
        if (err) return callback(err)
        if (dirExists) return fs.symlink(srcpath, dstpath, type, callback)
        mkdirs(dir, err => ***REMOVED***
          if (err) return callback(err)
          fs.symlink(srcpath, dstpath, type, callback)
    ***REMOVED***)
  ***REMOVED***)
***REMOVED***)
***REMOVED***)
***REMOVED***

function createSymlinkSync (srcpath, dstpath, type) ***REMOVED***
  let stats
  try ***REMOVED***
    stats = fs.lstatSync(dstpath)
***REMOVED*** catch ***REMOVED******REMOVED***
  if (stats && stats.isSymbolicLink()) ***REMOVED***
    const srcStat = fs.statSync(srcpath)
    const dstStat = fs.statSync(dstpath)
    if (areIdentical(srcStat, dstStat)) return
***REMOVED***

  const relative = symlinkPathsSync(srcpath, dstpath)
  srcpath = relative.toDst
  type = symlinkTypeSync(relative.toCwd, type)
  const dir = path.dirname(dstpath)
  const exists = fs.existsSync(dir)
  if (exists) return fs.symlinkSync(srcpath, dstpath, type)
  mkdirsSync(dir)
  return fs.symlinkSync(srcpath, dstpath, type)
***REMOVED***

module.exports = ***REMOVED***
  createSymlink: u(createSymlink),
  createSymlinkSync
***REMOVED***
